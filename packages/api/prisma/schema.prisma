// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // Used if DIRECT_URL not set (fallback to pooler)
  directUrl = env("DIRECT_URL") // Direct connection (port 5432) - preferred for queries and migrations
}

model User {
  id           String              @id // Clerk user ID
  email        String?
  firstName    String?             @map("first_name")
  lastName     String?             @map("last_name")
  imageUrl     String?             @map("image_url")
  roles        Json                @default("[]") // Array of role strings: ["user", "admin"]
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")
  bots         Bot[]
  chatSessions ChatSession[]
  apiCredentials UserApiCredential[]
  memories     AgentMemory[]

  @@map("users")
}

model Bot {
  id          Int           @id @default(autoincrement())
  userId      String        @map("user_id")
  name        String
  description String?
  avatarUrl   String?       @map("avatar_url")
  createdAt   DateTime      @default(now()) @map("created_at")
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  configs     BotConfig[]
  sessions    ChatSession[]
  memories    AgentMemory[]

  @@index([userId])
  @@map("bots")
}

model BotConfig {
  id          Int      @id @default(autoincrement())
  botId       Int      @map("bot_id")
  configKey   String   @map("config_key")
  configValue Json     @map("config_value")
  createdAt   DateTime @default(now()) @map("created_at")
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, configKey])
  @@map("bot_configs")
}

model ChatSession {
  id           Int           @id @default(autoincrement())
  userId       String        @map("user_id")
  botId        Int           @map("bot_id")
  sessionName  String?       @map("session_name")
  createdAt    DateTime      @default(now()) @map("created_at")
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  bot          Bot           @relation(fields: [botId], references: [id], onDelete: Cascade)
  messages     Message[]

  @@index([userId])
  @@index([botId])
  @@map("chat_sessions")
}

model Message {
  id          Int         @id @default(autoincrement())
  sessionId   Int         @map("session_id")
  role        String // 'user' | 'assistant' | 'system'
  content     String
  metadata    Json?
  rawRequest  Json?       @map("raw_request") // Raw OpenAI request JSON for user messages
  rawResponse Json?       @map("raw_response") // Raw OpenAI response JSON for assistant messages
  createdAt   DateTime    @default(now()) @map("created_at")
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  translation MessageTranslation?

  @@index([sessionId, createdAt(sort: Desc)])
  @@map("messages")
}

model AgentMemory {
  id              Int                          @id @default(autoincrement())
  botId           Int                          @map("bot_id")
  userId          String                       @map("user_id")
  keyPoint        String                       @map("key_point")
  context         Json?
  vectorEmbedding Unsupported("vector(1536)")? @map("vector_embedding")
  createdAt       DateTime                     @default(now()) @map("created_at")
  updatedAt       DateTime                     @updatedAt @map("updated_at")
  updateCount     Int                          @default(0) @map("update_count")
  
  bot             Bot                          @relation(fields: [botId], references: [id], onDelete: Cascade)
  user            User                         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([botId, userId])
  @@index([botId, userId, createdAt(sort: Desc)])
  @@map("agent_memories")
}

model UserApiCredential {
  id          Int      @id @default(autoincrement())
  userId      String   @map("user_id")
  provider    String
  encryptedKey String  @map("encrypted_key")
  createdAt   DateTime @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@map("user_api_credentials")
}

model MessageTranslation {
  id          Int      @id @default(autoincrement())
  messageId   Int      @unique @map("message_id")
  translation String
  createdAt   DateTime @default(now()) @map("created_at")
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_translations")
}

model SystemConfig {
  id          Int      @id @default(autoincrement())
  configKey   String   @map("config_key")
  configValue Json     @map("config_value")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([configKey])
  @@map("system_configs")
}
