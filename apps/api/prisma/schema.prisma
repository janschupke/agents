// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // Used if DIRECT_URL not set (fallback to pooler)
  directUrl = env("DIRECT_URL") // Direct connection (port 5432) - preferred for queries and migrations
}

model User {
  id           String              @id // Clerk user ID
  email        String?
  firstName    String?             @map("first_name")
  lastName     String?             @map("last_name")
  imageUrl     String?             @map("image_url")
  roles        Json                @default("[]") // Array of role strings: ["user", "admin"]
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")
  agents      Agent[]
  chatSessions ChatSession[]
  apiCredentials UserApiCredential[]
  memories     AgentMemory[]
  savedWords   SavedWord[]

  @@map("users")
}

model Agent {
  id          Int           @id @default(autoincrement())
  userId      String        @map("user_id")
  name        String
  description String?
  avatarUrl   String?       @map("avatar_url")
  createdAt   DateTime      @default(now()) @map("created_at")
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  configs     AgentConfig[]
  sessions    ChatSession[]
  memories    AgentMemory[]
  savedWords  SavedWord[]

  @@index([userId])
  @@map("agents")
}

model AgentConfig {
  id          Int      @id @default(autoincrement())
  agentId     Int      @map("agent_id")
  configKey   String   @map("config_key")
  configValue Json     @map("config_value")
  createdAt   DateTime @default(now()) @map("created_at")
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, configKey])
  @@map("agent_configs")
}

model ChatSession {
  id           Int           @id @default(autoincrement())
  userId       String        @map("user_id")
  agentId      Int           @map("agent_id")
  sessionName  String?       @map("session_name")
  createdAt    DateTime      @default(now()) @map("created_at")
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent        Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  messages     Message[]
  savedWords   SavedWord[]

  @@index([userId])
  @@index([agentId])
  @@map("chat_sessions")
}

model Message {
  id          Int         @id @default(autoincrement())
  sessionId   Int         @map("session_id")
  role        String // 'user' | 'assistant' | 'system'
  content     String
  metadata    Json?
  rawRequest  Json?       @map("raw_request") // Raw OpenAI request JSON for user messages
  rawResponse Json?       @map("raw_response") // Raw OpenAI response JSON for assistant messages
  createdAt   DateTime    @default(now()) @map("created_at")
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  translation MessageTranslation?
  wordTranslations MessageWordTranslation[]
  savedWordSentences SavedWordSentence[]

  @@index([sessionId, createdAt(sort: Desc)])
  @@map("messages")
}

model AgentMemory {
  id              Int                          @id @default(autoincrement())
  agentId         Int                          @map("agent_id")
  userId          String                       @map("user_id")
  keyPoint        String                       @map("key_point")
  context         Json?
  vectorEmbedding Unsupported("vector(1536)")? @map("vector_embedding")
  createdAt       DateTime                     @default(now()) @map("created_at")
  updatedAt       DateTime                     @updatedAt @map("updated_at")
  updateCount     Int                          @default(0) @map("update_count")
  
  agent           Agent                        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user            User                         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([agentId, userId])
  @@index([agentId, userId, createdAt(sort: Desc)])
  @@map("agent_memories")
}

model UserApiCredential {
  id          Int      @id @default(autoincrement())
  userId      String   @map("user_id")
  provider    String
  encryptedKey String  @map("encrypted_key")
  createdAt   DateTime @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@map("user_api_credentials")
}

model MessageTranslation {
  id          Int      @id @default(autoincrement())
  messageId   Int      @unique @map("message_id")
  translation String
  createdAt   DateTime @default(now()) @map("created_at")
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_translations")
}

model MessageWordTranslation {
  id          Int      @id @default(autoincrement())
  messageId   Int      @map("message_id")
  originalWord String  @map("original_word") // The word/token as it appears in the message
  translation  String  // The English translation of the word in context
  sentenceContext String? @map("sentence_context") // The sentence the word appears in (populated from message)
  createdAt   DateTime @default(now()) @map("created_at")
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_word_translations")
}

model SystemConfig {
  id          Int      @id @default(autoincrement())
  configKey   String   @map("config_key")
  configValue Json     @map("config_value")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([configKey])
  @@map("system_configs")
}

model SavedWord {
  id            Int      @id @default(autoincrement())
  userId        String   @map("user_id")
  originalWord  String   @map("original_word")
  translation   String
  pinyin        String?
  agentId       Int?     @map("agent_id")
  sessionId     Int?     @map("session_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent         Agent?   @relation(fields: [agentId], references: [id], onDelete: SetNull)
  session       ChatSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  sentences     SavedWordSentence[]

  @@index([userId])
  @@index([originalWord])
  @@index([userId, originalWord])
  @@map("saved_words")
}

model SavedWordSentence {
  id            Int       @id @default(autoincrement())
  savedWordId   Int       @map("saved_word_id")
  sentence      String
  messageId     Int?      @map("message_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  savedWord     SavedWord @relation(fields: [savedWordId], references: [id], onDelete: Cascade)
  message       Message?  @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([savedWordId])
  @@map("saved_word_sentences")
}
